
import Cocoa

//-----------------------------------------------------------------------------*

@objc(%!DOCUMENT_NAME%) class %!DOCUMENT_NAME% : PMManagedDocument%
foreach TRANSIENT_LIST_FOR_IMPLEMENTATION do
%,\n                                   protocol_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]
end
% {

  //---------------------------------------------------------------------------*
  //    Outlets                                                                *
  //---------------------------------------------------------------------------*

%
foreach OUTLET_GENERATION_LIST do
%  @IBOutlet var %!mOutletName% : %!mOutletType%?\n%
end
%
  //---------------------------------------------------------------------------*
  //    Controllers                                                            *
  //---------------------------------------------------------------------------*

%
foreach CONTROLLER_MAP do
%  var %!lkey->string% : %!mControllerClassName% \n%
end
%
  //---------------------------------------------------------------------------*
  //    Documents attributes                                                   *
  //---------------------------------------------------------------------------*

%

foreach ATTRIBUTE_LIST do
%//--- '%!mAttributeName%' attribute\n%
%  @property%![mType propertyAttributeString]% %![mType ocTypeName]% %!mAttributeName% ;\n%
%  - (void) addObserverOf_%!mAttributeName%: (id) inObserver ;\n%
%  - (void) removeObserverOf_%!mAttributeName%: (id) inObserver ;\n\n%
end
foreach ATTRIBUTE_LIST do
%  @private NSMutableSet * %!mAttributeName%_observers ;\n%
end
%
  //---------------------------------------------------------------------------*
  //    init                                                                   *
  //---------------------------------------------------------------------------*

  init () {
    let em = PMObjectManager ()
%
foreach CONTROLLER_MAP do
  %    %!lkey->string% = %!mControllerClassName% (%
  if mControlledClassOrEntityName->string != "" then
    %entityManager:em, inClassName:"%!mControlledClassOrEntityName->string%"%
  end
  %)\n%
end
%    super.init (inEntityManager:em)
  }
  
  //---------------------------------------------------------------------------*
  //    windowNibName                                                          *
  //---------------------------------------------------------------------------*

  override var windowNibName: String {
    return "%!DOCUMENT_NAME%"
  }

  //---------------------------------------------------------------------------*
  //    rootEntityClassName                                                    *
  //---------------------------------------------------------------------------*

  override func rootEntityClassName () -> String {
    return "%!ROOT_ENTITY_NAME%"
  }

  //---------------------------------------------------------------------------*
  //    rootObject                                                             *
  //---------------------------------------------------------------------------*

  var rootObject : MyRootEntity {
    get {
      return mRootObject as %!ROOT_ENTITY_NAME%
    }
  }

  //---------------------------------------------------------------------------*
  //    windowControllerDidLoadNib                                             *
  //---------------------------------------------------------------------------*

  override func windowControllerDidLoadNib (aController: NSWindowController) {
    super.windowControllerDidLoadNib (aController)
  //--------------------------- Controller bindings
%
foreach CONTROLLER_MAP do
  foreach mControllerBindingList
  before 
    %//--- '%!lkey->string%' controller bindings\n%
  do
   ![mBinding generateSwiftBinding !lkey->string]
  end
end
%  //--------------------------- Outlet bindings
%

foreach OUTLET_GENERATION_LIST do
   %  //--- Outlet %!mOutletName%\n%
   %    if nil == %!mOutletName% {\n%
   %      presentErrorWindow (__FILE__, __LINE__, "the '%!mOutletName%' outlet is nil") ;\n%
   %    }\n%
  foreach mOutletBindingList do
    ![mBinding generateSwiftBinding !mOutletName]
  end
end
%  //--------------------------- Add Transient observers
%!generateAddSwiftObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION !""]
%  //--------------------------- Add Signature observer
%
if HAS_SIGNATURE_OBSERVER then
  %  [mRootObject addSignatureObserver:self] ;\n%
end
%}

  //---------------------------------------------------------------------------*
  //   R E M O V E    W I N D O W    C O N T R O L L E R                       *
  //---------------------------------------------------------------------------*

  override func removeWindowController (inWindowController : NSWindowController) {
  //--------------------------- Add Signature observer
%
if HAS_SIGNATURE_OBSERVER then
  %  [mRootObject removeSignatureObserver:self] ;\n%
end
%  //--- Unbind Outlets
%foreach OUTLET_GENERATION_LIST do
  foreach > mOutletBindingList do
    ![mBinding generateSwiftRemoveBinding !mOutletName]
  end
end
%  //--- Unbind Controllers
%foreach CONTROLLER_MAP do
  foreach mControllerBindingList do
   ![mBinding generateSwiftRemoveBinding !lkey->string]
  end
end
%  //--- Remove Transient observers
%!generateRemoveSwiftObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION]
%  //--- Release controllers
%foreach CONTROLLER_MAP do
  %    // %!lkey->string% = nil\n%
end
%  //--- Remove circularities in outlets
%foreach OUTLET_GENERATION_LIST do
  if mImplementsDeallocProtocol then
    %  [%!mOutletName% objectWillBeDeallocated] ;\n%
  end 
end
%  //---
    super.removeWindowController (inWindowController)
  }

%

!generateSwiftObserverRoutinesForTransient [!DOCUMENT_NAME !TRANSIENT_LIST_FOR_IMPLEMENTATION !"document"]

foreach TRANSIENT_LIST_FOR_IMPLEMENTATION do
%  //---------------------------------------------------------------------------*
  //    %!["Transient: " + mTransientName stringByRightPadding !71 !' ']%*
  //---------------------------------------------------------------------------*\n\n%
%  var %!mTransientName%__cache : %![mTransientType swiftTypeName]%?\n%
%  var %!mTransientName% : %![mTransientType swiftTypeName]% {\n%
!generateSwiftTransientCacheRoutine [!DOCUMENT_NAME !mTransientType !mTransientName !mDependencyList !mRootSignDependencyList]
%  }

  func %!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_didChange () {
    self.willChangeValueForKey ("%!mTransientName%")
    self.didChangeValueForKey  ("%!mTransientName%")
  }
 
%
end
%}

//-----------------------------------------------------------------------------*

