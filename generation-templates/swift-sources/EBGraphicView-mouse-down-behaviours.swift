//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
//  THIS FILE IS GENERATED BY EASY BINDINGS, DO NOT MODIFY IT
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

import Cocoa

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

class DefaultMouseDownBehaviour {

  //····················································································································

  public func onMouseDraggedOrModifierFlagsChanged (_ inMouseDraggedLocation : NSPoint,
                                                    _ inModifierFlags : NSEvent.ModifierFlags,
                                                    _ inGraphicView : EBGraphicView) {
  }

  //····················································································································

  public func abortOperation (_ inGraphicView : EBGraphicView) {
  }

  //····················································································································

  public func onMouseUp (_ inUnalignedMouseUpLocation : NSPoint,
                         _ inGraphicView : EBGraphicView) {
  }

  //····················································································································
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

final class MouseDownOutsideAnyObjectBehaviour : DefaultMouseDownBehaviour { // Mouse down without any modifier, outside any object

  //····················································································································

  private let mMouseDownUnalignedLocation : NSPoint

  //····················································································································

  public init (_ inUnalignedLocation : NSPoint, _ inViewController : EBGraphicViewControllerProtocol) {
    self.mMouseDownUnalignedLocation = inUnalignedLocation
    inViewController.clearSelection ()
  }

  //····················································································································

  public override func onMouseDraggedOrModifierFlagsChanged (_ inMouseDraggedLocation : NSPoint,
                                                             _ inModifierFlags : NSEvent.ModifierFlags,
                                                             _ inGraphicView : EBGraphicView) {
    let r = NSRect (point: self.mMouseDownUnalignedLocation, point: inMouseDraggedLocation)
    inGraphicView.mSelectionRectangle = r
    let indexSet : Set <Int> = inGraphicView.indexesOfObjects (intersecting: r)
    inGraphicView.viewController?.setSelection (objectsWithIndexes: Array (indexSet))
  }

  //····················································································································

}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

final class MouseDownOnObjectBehaviour : DefaultMouseDownBehaviour { // Mouse down without any modifier, on an object

  //····················································································································

  private let mMouseDownUnalignedLocation : NSPoint
  private var mLastMouseDraggedAlignedLocation : CanariPoint
  private let mObjectIndex : Int
  private let mPossibleKnobIndex : Int? //  knob index
  private let mObjectWasSelected : Bool

  //····················································································································

  public init (_ inUnalignedLocation : NSPoint,
               objectIndex inObjectIndex : Int,
               possibleKnobIndex inPossibleKnobIndex : Int?,
               _ inGraphicView : EBGraphicView,
               _ inViewController : EBGraphicViewControllerProtocol) {
    self.mMouseDownUnalignedLocation = inUnalignedLocation
    self.mLastMouseDraggedAlignedLocation = inUnalignedLocation.canariPointAligned (onCanariGrid: inGraphicView.mouseGridInCanariUnit)
    self.mObjectIndex = inObjectIndex
    self.mPossibleKnobIndex = inPossibleKnobIndex
    self.mObjectWasSelected = inViewController.selectedIndexesSet.contains (inObjectIndex)
    if !self.mObjectWasSelected {
      inViewController.setSelection (objectsWithIndexes: [inObjectIndex])
    }
  }

  //····················································································································

  public override func onMouseDraggedOrModifierFlagsChanged (_ inMouseDraggedLocation : NSPoint,
                                                             _ inModifierFlags : NSEvent.ModifierFlags,
                                                             _ inGraphicView : EBGraphicView) {
    let mouseDraggedCanariLocation = inMouseDraggedLocation.canariPointAligned (onCanariGrid: inGraphicView.mouseGridInCanariUnit)
    var proposedTranslation = CanariPoint (
      x: mouseDraggedCanariLocation.x - self.mLastMouseDraggedAlignedLocation.x,
      y: mouseDraggedCanariLocation.y - self.mLastMouseDraggedAlignedLocation.y
    )
    if inGraphicView.mDraggingObjectsIsAlignedOnArrowKeyMagnitude {
      proposedTranslation = proposedTranslation.point (alignedOnGrid: inGraphicView.mouseGridInCanariUnit)
    }
    inGraphicView.guideFor (objectIndexes: [self.mObjectIndex])
    inGraphicView.drag (knob: self.mPossibleKnobIndex, objectIndex: self.mObjectIndex, proposedTranslation, mouseDraggedCanariLocation)
    self.mLastMouseDraggedAlignedLocation = mouseDraggedCanariLocation
  }

  //····················································································································

}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

final class ShiftMouseDownBehaviour : DefaultMouseDownBehaviour { // Mouse down without only shift modifier

  //····················································································································

  private let mMouseDownUnalignedLocation : NSPoint
  private let mSelectedObjectIndexSet : Set <Int>
  private let mPossibleObjectIndex : Int?

  //····················································································································

  public init (_ inUnalignedLocation : NSPoint, _ inPossibleObjectIndex : Int?, _ inViewController : EBGraphicViewControllerProtocol) {
    self.mMouseDownUnalignedLocation = inUnalignedLocation
    self.mSelectedObjectIndexSet = inViewController.selectedIndexesSet
    self.mPossibleObjectIndex = inPossibleObjectIndex
    if let objectIndex = inPossibleObjectIndex {
      inViewController.setSelection (objectsWithIndexes: Array (self.mSelectedObjectIndexSet.symmetricDifference ([objectIndex])))
    }
  }

  //····················································································································

  public override func onMouseDraggedOrModifierFlagsChanged (_ inMouseDraggedLocation : NSPoint,
                                                             _ inModifierFlags : NSEvent.ModifierFlags,
                                                             _ inGraphicView : EBGraphicView) {
    let r = NSRect (point: self.mMouseDownUnalignedLocation, point: inMouseDraggedLocation)
    inGraphicView.mSelectionRectangle = r
    let indexSet : Set <Int> = inGraphicView.indexesOfObjects (intersecting: r)
    inGraphicView.viewController?.setSelection (objectsWithIndexes: Array (indexSet.symmetricDifference (self.mSelectedObjectIndexSet)))
  }

  //····················································································································

}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

final class OptionMouseDownBehaviour : DefaultMouseDownBehaviour { // Mouse down without only option modifier

  //····················································································································

  private var mOperationInProgress : Bool

  //····················································································································

  public init (_ inUnalignedLocation : NSPoint,
               _ inGraphicView : EBGraphicView,
               _ inViewController : EBGraphicViewControllerProtocol) {
    self.mOperationInProgress = true
    inViewController.ebUndoManager?.beginUndoGrouping ()
    inGraphicView.mStartOptionMouseDownCallback? (inUnalignedLocation)
  }

  //····················································································································

  public override func onMouseDraggedOrModifierFlagsChanged (_ inMouseDraggedLocation : NSPoint,
                                                             _ inModifierFlags : NSEvent.ModifierFlags,
                                                             _ inGraphicView : EBGraphicView) {
    if self.mOperationInProgress {
      inGraphicView.mContinueOptionMouseDraggedCallback? (inMouseDraggedLocation, inModifierFlags)
    }
  }

  //····················································································································

  override public func abortOperation (_ inGraphicView : EBGraphicView) {
    if self.mOperationInProgress {
      self.mOperationInProgress = false
      inGraphicView.mAbortOptionMouseOperationCallback? ()
      inGraphicView.viewController?.ebUndoManager?.endUndoGrouping ()
      inGraphicView.viewController?.ebUndoManager?.undo ()
    }
  }

  //····················································································································

  override public func onMouseUp (_ inUnalignedMouseUpLocation : NSPoint,
                                  _ inGraphicView : EBGraphicView) {
    if self.mOperationInProgress {
      let accepts = inGraphicView.mStopOptionMouseUpCallback? (inUnalignedMouseUpLocation) ?? true
      inGraphicView.viewController?.ebUndoManager?.endUndoGrouping ()
      if !accepts {
        inGraphicView.viewController?.ebUndoManager?.undo ()
      }
    }
  }

  //····················································································································

}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
