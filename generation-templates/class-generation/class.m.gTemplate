#import "PMTransientDependancyManager.h"
#import "PMAllocationDebug.h"
#import "easy-bindings-utilities.h"
#import "%!CLASS_NAME%.h"
%
if [TRANSIENT_LIST_FOR_IMPLEMENTATION length] > 0 then
  %#import "%!CLASS_NAME%-transient-computations.h"\n%
end if
foreach IMPLEMENTATION_INCLUSION_SET do
  %#import "%!key%.h"\n%
end foreach
%
#import <objc/runtime.h>

//----------------------------------------------------------------------------*

@implementation %!CLASS_NAME%

//----------------------------------------------------------------------------*
//    Synthesize properties                                                   *
//----------------------------------------------------------------------------*

%foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
%@synthesize %!mAttributeName% ;\n%
end foreach
%
//----------------------------------------------------------------------------*
//    Init Methods                                                            *
//----------------------------------------------------------------------------*

- (instancetype) init {
  self = [super init] ;
  if (self) {
%if SUPER_CLASS_NAME == "" then
%    macroNoteObjectAllocation ;
%end if
foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
  %    %!mAttributeName% = %!mDirectDefaultValue% ;\n%
end foreach
!generateAddObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION !"  "]
%    [self %!CLASS_NAME%_did_init] ;
  }
  return self ;
}

//----------------------------------------------------------------------------*

%foreach ALL_PROPERTIES_FOR_INIT_METHOD_HEADER
  before %- (instancetype) %?^%initWith%
  do ![mAttributeName stringByCapitalizingFirstCharacter]%: (%![mType ocTypeName]%) in%![mAttributeName stringByCapitalizingFirstCharacter]
  between %\n%!^%with%
  after % {\n%
end foreach
if [INHERITED_PROPERTIES_FOR_SUPER_INIT_CALL length] == 0 then
  %  self = [super init] ;\n%
else
foreach INHERITED_PROPERTIES_FOR_SUPER_INIT_CALL
  before %  self = [super\n%
    %    initWith%
  do ![mAttributeName stringByCapitalizingFirstCharacter]%:in%![mAttributeName stringByCapitalizingFirstCharacter]
  between %\n    with%
  after %\n  ] ;\n%
end foreach
end if
%  if (self) {  
%
if SUPER_CLASS_NAME == "" then
%    macroNoteObjectAllocation ;
%end if

foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
  %    %!mAttributeName% = in%![mAttributeName stringByCapitalizingFirstCharacter]% ;\n%
end foreach

!generateAddObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION !"  "]
%    [self %!CLASS_NAME%_did_init] ;
  }
  return self ;
}
%if SUPER_CLASS_NAME == "" then
%
//----------------------------------------------------------------------------*
//    Dealloc                                                                 *
//----------------------------------------------------------------------------*

#ifdef PM_COCOA_DEBUG
  - (void) dealloc {
    macroNoteObjectDeallocation ;
    macroSuperDealloc ;
  }
#endif
%end if%
//----------------------------------------------------------------------------*
//    removeObservers                                                         *
//----------------------------------------------------------------------------*

- (void) removeObservers {
//--- Remove Transient observers
%!generateRemoveObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION]
if SUPER_CLASS_NAME != "" then
%  [super removeObservers] ;
%end if%}

%if [PROPERTY_LIST_FOR_IMPLEMENTATION length] > 0 then
%//----------------------------------------------------------------------------*
//    Swizzle                                                                 *
//----------------------------------------------------------------------------*

+ (void) load {
  Method original, swizzled ;
%
foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
%  original = class_getInstanceMethod (self, @selector (set%![mAttributeName stringByCapitalizingFirstCharacter]%:));
  swizzled = class_getInstanceMethod (self, @selector (set%![mAttributeName stringByCapitalizingFirstCharacter]%_swizzle:));
  method_exchangeImplementations (original, swizzled) ;
%end foreach
%}

%
end if

foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
%//----------------------------------------------------------------------------*
//    '%!mAttributeName%' attribute                                            *
//----------------------------------------------------------------------------*

- (void) set%![mAttributeName stringByCapitalizingFirstCharacter]%_swizzle: (%![mType ocTypeName]%) inObject {
%if [mType equalMethod] == "" then
%  if (%!mAttributeName% != inObject) {
%else
%  if (! [self.%!mAttributeName% %![mType equalMethod]%:inObject]) {
%end if%    [self set%![mAttributeName stringByCapitalizingFirstCharacter]%_swizzle:inObject] ;
    [%!mAttributeName%_observers makeObjectsPerformSelector:@selector (%!["class." . CLASS_NAME . "." . mAttributeName identifierRepresentation]%_didChange)] ;
%!generateTransientTriggering [!mAttributeName !CLASS_NAME !TRANSIENT_LIST_FOR_IMPLEMENTATION !"class"]

%  }
}

//----------------------------------------------------------------------------*

- (void) addObserverOf_%!mAttributeName%: (id) inObserver {
  if (nil == %!mAttributeName%_observers) {
    %!mAttributeName%_observers = [NSMutableSet new] ;
  }
  [%!mAttributeName%_observers addObject:inObserver] ;
  [inObserver performSelector:@selector (%!["class." . CLASS_NAME . "." . mAttributeName identifierRepresentation]%_didChange)] ;
}

//----------------------------------------------------------------------------*

- (void) removeObserverOf_%!mAttributeName%: (id) inObserver {
  [%!mAttributeName%_observers removeObject:inObserver] ;
  [inObserver performSelector:@selector (%!["class." . CLASS_NAME . "." . mAttributeName identifierRepresentation]%_didChange)] ;
}

%end foreach

!generateTransientCacheRoutine [!CLASS_NAME !TRANSIENT_LIST_FOR_IMPLEMENTATION]%

//----------------------------------------------------------------------------*

