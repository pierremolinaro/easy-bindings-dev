#import "easy-bindings-utilities.h"
#import "PMAllocationDebug.h"
#import "PMTransientDependancyManager.h"
#import "%!CLASS_NAME%.h"
%
if [TRANSIENT_LIST_FOR_IMPLEMENTATION length] > 0 then
  %#import "%!CLASS_NAME%-transient-computations.h"\n%
end if
foreach INCLUSION_SET do
  %#import "%!key%.h"\n%
end foreach
%

//----------------------------------------------------------------------------*

@implementation %!CLASS_NAME%

//----------------------------------------------------------------------------*
//    Synthesize properties                                                   *
//----------------------------------------------------------------------------*

//--- Attributes
%foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
  if [mType isClass] then
    %@dynamic %!mPropertyName% ;\n%
  end if
end foreach
%
//--- To-many relationships
%
foreach TO_MANY_RELATIONSHIPS do
%@dynamic %!mValue0% ; // Set of %!mValue1% entities\n%
end foreach
%
//----------------------------------------------------------------------------*
//    Creation Class Method                                                   *
//----------------------------------------------------------------------------*

+ (%!CLASS_NAME% *) pmInsertNewObjectIntoManagedObjectContext:(NSManagedObjectContext *) inContext {
  return [NSEntityDescription insertNewObjectForEntityForName:@"%!ENTITY_NAME%" inManagedObjectContext:inContext] ;
}

//----------------------------------------------------------------------------*
//    initWithEntity:insertIntoManagedObjectContext:                          *
//----------------------------------------------------------------------------*

- (id) initWithEntity:(NSEntityDescription *) inEntity
       insertIntoManagedObjectContext:(NSManagedObjectContext *) inManagedObjectContext {
  self = [super 
    initWithEntity:inEntity
    insertIntoManagedObjectContext:inManagedObjectContext
  ] ;
  if (self) {
    macroNoteObjectAllocation (self) ;
  //--- Add Transient observers
%!generateAddObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION !"  "]
%  }
  return self ;
}

//----------------------------------------------------------------------------*
//    Dealloc                                                                 *
//----------------------------------------------------------------------------*

- (void) dealloc {
  macroNoteObjectDeallocation (self) ;
}

//----------------------------------------------------------------------------*
//    didTurnIntoFault                                                        *
//----------------------------------------------------------------------------*

- (void) didTurnIntoFault {
//--- Remove Transient observers
%!generateRemoveObserverForTransients [!TRANSIENT_LIST_FOR_IMPLEMENTATION]
%//---
  [super didTurnIntoFault] ;
}

%foreach PROPERTY_LIST_FOR_IMPLEMENTATION do
  if [mType nonStandardAttributeNamePrefix] != "" then
    %//----------------------------------------------------------------------------*\n%
    %//    Custom accessors for '%!mPropertyName%'                                 *\n%
    %//----------------------------------------------------------------------------*\n\n%
    %- (void) set%![mPropertyName stringByCapitalizingFirstCharacter]%: (%![mType ocTypeName]%) inValue {\n%
    %  [self setValue:%![mType attributeValueEncoder]% (inValue) forKey:@"%![mType nonStandardAttributeNamePrefix]!mPropertyName%"] ;\n%
    %}\n\n%
    %//----------------------------------------------------------------------------*\n\n%
    %- (%![mType ocTypeName]%) %!mPropertyName% {\n%
    %  return %![mType attributeValueDecoder]% ([self valueForKey:@"%![mType nonStandardAttributeNamePrefix]!mPropertyName%"]) ;\n%
    %}\n%
  elsif not [mType isClass] then
    %//----------------------------------------------------------------------------*\n%
    %//    Custom accessors for '%!mPropertyName%'                                 *\n%
    %//----------------------------------------------------------------------------*\n\n%
    %- (void) set%![mPropertyName stringByCapitalizingFirstCharacter]%: (%![mType ocTypeName]%) inValue {\n%
    %  id value = %![mType customSetterTransformer]% ;\n%
    %  [self willChangeValueForKey:@"%!mPropertyName%"] ;\n%
    %  [self setPrimitiveValue:value forKey:@"%!mPropertyName%"] ;\n%
    %  [self didChangeValueForKey:@"%!mPropertyName%"] ;\n%
    %}\n\n%
    %//----------------------------------------------------------------------------*\n\n%
    %- (%![mType ocTypeName]%) %!mPropertyName% {\n%
    %  [self willAccessValueForKey:@"%!mPropertyName%"] ;\n%
    %  const %![mType ocTypeName]% value = [[self primitiveValueForKey:@"%!mPropertyName%"] %![mType customGetterMethod]%] ;\n%
    %  [self didAccessValueForKey:@"%!mPropertyName%"] ;\n%
    %  return value ;\n%
    %}\n%
  end if
end foreach

if [PROPERTY_TOMANY_RELATIONSHIP_SET count] > 0 then
%//----------------------------------------------------------------------------*
//    didChangeValueForKey                                                    *
//----------------------------------------------------------------------------*

- (void) didChangeValueForKey: (NSString *) inKey {
  [super didChangeValueForKey:inKey] ;
 %foreach PROPERTY_TOMANY_RELATIONSHIP_SET do
% if ([inKey isEqualToString:@"%!key%"]) {
    [%!key%_observers makeObjectsPerformSelector:@selector (%!["entity." . ENTITY_NAME . "." . key identifierRepresentation]%_didChange)] ;
%!generateTransientTriggering [!key !ENTITY_NAME !TRANSIENT_LIST_FOR_IMPLEMENTATION !"entity"]
between %  }else%
end foreach
%  }
}
%end if




foreach PROPERTY_LIST_FOR_IMPLEMENTATION do%
//----------------------------------------------------------------------------*

- (void) addObserverOf_%!mPropertyName%: (id) inObserver {
  if (nil == %!mPropertyName%_observers) {
    %!mPropertyName%_observers = [NSMutableSet new] ;
  }
  [%!mPropertyName%_observers addObject:inObserver] ;
  [inObserver performSelector:@selector (%!CLASS_NAME%_%!mPropertyName%_didChange)] ;
}

//----------------------------------------------------------------------------*

- (void) removeObserverOf_%!mPropertyName%: (id) inObserver {
  [%!mPropertyName%_observers removeObject:inObserver] ;
  [inObserver performSelector:@selector (%!CLASS_NAME%_%!mPropertyName%_didChange)] ;
}

%
end foreach

foreach TO_MANY_RELATIONSHIPS do%
//----------------------------------------------------------------------------*

- (void) addObserverOf_%!mValue0%: (id) inObserver {
  if (nil == %!mValue0%_observers) {
    %!mValue0%_observers = [NSMutableSet new] ;
  }
  [%!mValue0%_observers addObject:inObserver] ;
  [inObserver performSelector:@selector (%!["entity." . ENTITY_NAME . "." . mValue0 identifierRepresentation]%_didChange)] ;
}

//----------------------------------------------------------------------------*

- (void) removeObserverOf_%!mValue0%: (id) inObserver {
  [%!mValue0%_observers removeObject:inObserver] ;
  [inObserver performSelector:@selector (%!["entity." . ENTITY_NAME . "." . mValue0 identifierRepresentation]%_didChange)] ;
}

%
end foreach

!generateObserverRoutinesForTransient [!ENTITY_NAME !TRANSIENT_LIST_FOR_IMPLEMENTATION !"entity"]

!generateTransientCacheRoutine [!CLASS_NAME !TRANSIENT_LIST_FOR_IMPLEMENTATION]
%//----------------------------------------------------------------------------*

