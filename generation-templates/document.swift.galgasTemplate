
import Cocoa

//---------------------------------------------------------------------------------------------------------------------*

@objc(%!DOCUMENT_NAME%) class %!DOCUMENT_NAME% : PMManagedDocument, PMUserClassName {

  //-------------------------------------------------------------------------------------------------------------------*
  //    userClassName                                                                                                  *
  //-------------------------------------------------------------------------------------------------------------------*

  override func userClassName () -> String { return "%!DOCUMENT_NAME%" }

  //-------------------------------------------------------------------------------------------------------------------*
  //    Outlets                                                                                                        *
  //-------------------------------------------------------------------------------------------------------------------*

%
for () in OUTLET_GENERATION_MAP do
%  @IBOutlet var %!lkey.string% : %!mOutletTypeName.string%?\n%
end
%
  //-------------------------------------------------------------------------------------------------------------------*
  //    Controllers                                                                                                    *
  //-------------------------------------------------------------------------------------------------------------------*

  //-------------------------------------------------------------------------------------------------------------------*
  //    Document attributes                                                                                            *
  //-------------------------------------------------------------------------------------------------------------------*

%

for () in ATTRIBUTE_LIST do
%
  //-------------------------------------------------------------------------------------------------------------------*
  //    %!["Attribute: " + mAttributeName stringByRightPadding !111 !' ']%*
  //-------------------------------------------------------------------------------------------------------------------*\n\n%
%  var %!mAttributeName%_observers = NSMutableSet ()\n%
%  var %!mAttributeName% : %![mAttributeType swiftTypeName]% = %!mDefaultValueInSwift% {
    didSet {
      if %!mAttributeName% != oldValue {
        for anyObject in %!mAttributeName%_observers {
          let object = anyObject as PMTransientEventProtocol
          postTransientEvent (object)
        }
      }
    }
  }

  func addObserverOf_%!mAttributeName% (inObserver : PMTransientEventProtocol, inTrigger:Bool) {
    %!mAttributeName%_observers.addObject (inObserver)
    if inTrigger {
      postTransientEvent (inObserver)
    }
  }
 
  func removeObserverOf_%!mAttributeName% (inObserver : PMTransientEventProtocol, inTrigger:Bool) {
    %!mAttributeName%_observers.removeObject (inObserver)
    if inTrigger {
      postTransientEvent (inObserver)
    }
  }
%if not mNeedsValidation then%
  func validate_%!mAttributeName% (proposedValue : %![mAttributeType swiftTypeName]%) -> PMValidationResult { return PMValidationResult.ok }

%
end
end
%
  //-------------------------------------------------------------------------------------------------------------------*
  //    windowNibName                                                                                                  *
  //-------------------------------------------------------------------------------------------------------------------*

  override var windowNibName: String {
    return "%!DOCUMENT_NAME%"
  }

  //-------------------------------------------------------------------------------------------------------------------*
  //    rootEntityClassName                                                                                            *
  //-------------------------------------------------------------------------------------------------------------------*

  override func rootEntityClassName () -> String {
    return "%!ROOT_ENTITY_NAME%"
  }

  //-------------------------------------------------------------------------------------------------------------------*
  //    rootObject                                                                                                     *
  //-------------------------------------------------------------------------------------------------------------------*

  var rootObject : MyRootEntity { get { return mRootObject as! %!ROOT_ENTITY_NAME% } }

%
for () in ARRAY_CONTROLLER_LIST do
%  //-------------------------------------------------------------------------------------------------------------------*
  //    %!["Array controller: " + mControllerName stringByRightPadding !111 !' ']%*
  //-------------------------------------------------------------------------------------------------------------------*
  
  private var %!mControllerName% : ArrayController_%!mObjectTypeName%_%!mTomanyRelationshipName%? = nil

  func document_2E_PMDocument_2E_%!mControllerName%_noteDidChange () {
    %!mControllerName%?.modelDidChange ()
  }

  func document_2E_PMDocument_2E_%!mControllerName%_trigger () {
    %!mControllerName%?.display ()
  }

%
end
%  //-------------------------------------------------------------------------------------------------------------------*
  //    windowControllerDidLoadNib                                                                                     *
  //-------------------------------------------------------------------------------------------------------------------*

%if [CONTROLLER_INSTANCIATION_LIST length] > 0 then
%  var mControllerArray : [PMTransientEventProtocol] = []\n\n%
%  //-------------------------------------------------------------------------------------------------------------------*\n\n%
end
%  override func windowControllerDidLoadNib (aController: NSWindowController) {
    super.windowControllerDidLoadNib (aController)
  //--------------------------- Outlet checking
%

for () in OUTLET_GENERATION_MAP do
   %    if nil == %!lkey.string% {\n%
   %      presentErrorWindow (__FILE__, __LINE__, "the '%!lkey.string%' outlet is nil") ;\n%
   %    }\n%
end
%  //--------------------------- Array controller
%
for () in ARRAY_CONTROLLER_LIST do
%    %!mControllerName% = ArrayController_%!mObjectTypeName%_%!mTomanyRelationshipName% (
      object:rootObject,
      tableView:%!mTableViewOutletName%,
      file:__FILE__,
      line:__LINE__
    )\n%
end
%  //--------------------------- Transient observers
%
for () in TRANSIENT_LIST_FOR_IMPLEMENTATION do
for () in mDependencyList do
%    %![mDependency generateAddObserverCall]% (event_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%, inTrigger:true)\n%
end
end
%  //--------------------------- Array controller as observers
%
for () in ARRAY_CONTROLLER_LIST do
%    rootObject.addObserverOf_%!mTomanyRelationshipName% (PMEvent_document_2E_PMDocument_2E_%!mControllerName% (object:self), inTrigger:true)\n%
end
%  //--------------------------- Simple controllers
%for () in CONTROLLER_INSTANCIATION_LIST do
%    mControllerArray.append (%!mValue%)\n%
end
%  //--------------------------- Set targets / actions
%for () in TARGET_ACTION_LIST do
%    %!mOutletName%?.target = %!mTargetName%\n%
%    %!mOutletName%?.action = "%!mActionName%:"\n%
end
%  //--------------------------- Update display
    flushTriggers ()
  }

  //-------------------------------------------------------------------------------------------------------------------*
  //   removeWindowController                                                                                          *
  //-------------------------------------------------------------------------------------------------------------------*

  override func removeWindowController (inWindowController : NSWindowController) {
  //--------------------------- Remove controllers
%
for () in ARRAY_CONTROLLER_LIST do
%    %!mControllerName%?.unregister ()\n%
end
if [CONTROLLER_INSTANCIATION_LIST length] > 0 then
%    for controller in mControllerArray {
      controller.unregister ()
    }
    mControllerArray = []
%
end
%  //--------------------------- Remove targets / actions
%for () in TARGET_ACTION_LIST do
%    %!mOutletName%?.target = nil\n%
end
%  //---
    super.removeWindowController (inWindowController)
  }

%

for () in TRANSIENT_LIST_FOR_IMPLEMENTATION do
%  //-------------------------------------------------------------------------------------------------------------------*
  //    %!["Transient: " + mTransientName stringByRightPadding !111 !' ']%*
  //-------------------------------------------------------------------------------------------------------------------*\n\n%
%  var %!mTransientName%_observers : [Int : PMTransientEventProtocol] = [:]\n%
%  var %!mTransientName%_cache : %![mTransientType swiftTypeName]%?\n%
%  var %!mTransientName% : %![mTransientType swiftTypeName]% {\n%
%    get {\n%
%      if %!mTransientName%_cache == nil {\n%
%        %!mTransientName%_cache = compute_%!DOCUMENT_NAME%_%!mTransientName% (%
for () in mDependencyList
do ![mDependency generateActualParameterForComputeFunction]
between %, %
end
%)\n%
%      }\n%
%      return %!mTransientName%_cache!\n%
%    }
  }

  func %!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_noteDidChange () {
    %!mTransientName%_cache = nil
  }

  func %!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_trigger () {
    for (key, object) in %!mTransientName%_observers {
      postTransientEvent (object)
    }
  }
 
   func addObserverOf_%!mTransientName% (inObserver : PMTransientEventProtocol, inTrigger:Bool) {
    %!mTransientName%_observers [inObserver.uniqueIndex] = inObserver
    if inTrigger {
      postTransientEvent (inObserver)
    }
  }
 
  func removeObserverOf_%!mTransientName% (inObserver : PMTransientEventProtocol, inTrigger:Bool) {
    %!mTransientName%_observers [inObserver.uniqueIndex] = nil
    if inTrigger {
      postTransientEvent (inObserver)
    }
  }

  var event_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_cache : PMEvent_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%? = nil
  var event_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]% : PMEvent_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]% {
    if event_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_cache == nil {
      event_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_cache = PMEvent_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]% (object:self)
    }
    return event_%!["document." + DOCUMENT_NAME + "." + mTransientName identifierRepresentation]%_cache!
  }\n
%end
%

//---------------------------------------------------------------------------------------------------------------------*

}

